<?php

//----------------------------------------------------------------------//
//              INITIALISATION
//----------------------------------------------------------------------//
// Chargement de Mustache.
require 'mustache/src/Mustache/Autoloader.php';
Mustache_Autoloader::register();

// Connexion à la base
try {
	$bdd = new PDO('mysql:host=localhost;dbname=blog', 'root', '');
	$bdd->query("SET NAMES 'utf8'");
} catch(Exception $e) {
	die('Erreur : '.$e->getMessage());
}
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              COMPTE LE NOMBRE TOTAL DE BILLETS
//----------------------------------------------------------------------//
$req = $bdd->query('
    SELECT 
        COUNT(*) AS nb 
    FROM 
        billets
');
$nb_billets = $req->fetch();
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              CHARGEMENT DES BILLETS
//----------------------------------------------------------------------//
$req = $bdd->query('
    SELECT 
        titre, 
        contenu, 
        id, 
        DATE_FORMAT(date_creation, \'%d/%m à %Hh%imin\') AS date_creation 
    FROM 
        billets 
    ORDER BY id DESC 
    LIMIT 0, 10
');
$billets = $req->fetchAll();
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              FERMETURE DE LA BASE
//----------------------------------------------------------------------//
$req->closeCursor();
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              PREPARATION DES DONNEES POUR LA VUE
//----------------------------------------------------------------------//
$data = array(
    "NB"        => $nb_billets['nb'],
    "POSTS"     => $billets,
);
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              RECUPERATION DU TEMPLATE (ou vue)
//----------------------------------------------------------------------//
$html = file_get_contents('View_Index.html');
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              AFFICHAGE
//----------------------------------------------------------------------//
$m = new Mustache_Engine();
echo $m->render($html, $data); 
//----------------------------------------------------------------------//

?>
