<?php

//----------------------------------------------------------------------//
//              INITIALISATION
//----------------------------------------------------------------------//
// Chargement de Mustache.
require 'mustache/src/Mustache/Autoloader.php';
Mustache_Autoloader::register();

// Connexion à la base
try {
	$bdd = new PDO('mysql:host=localhost;dbname=blog', 'root', '');
} catch(Exception $e) {
	die('Erreur : '.$e->getMessage());
}
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              COMPTE LE NOMBRE DE BILLETS
//----------------------------------------------------------------------//
$req = $bdd->query('
    SELECT 
        COUNT(*) AS nb_billets 
    FROM billets
');
$nbr_billets = $req->fetch();
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              CHARGEMENT DES BILLETS
//----------------------------------------------------------------------//
$bdd->query("SET NAMES 'utf8'");
$req = $bdd->query('
    SELECT 
        titre, contenu, id, DATE_FORMAT(date_creation, \'%d/%m à %Hh%imin\') AS date_creation 
    FROM billets 
    ORDER BY id DESC 
    LIMIT 0, 10
');
//----------------------------------------------------------------------//


//----------------------------------------------------------------------//
//              MISE EN TABLEAU DES DONNEES
//----------------------------------------------------------------------//
$posts = array();
while ($donnees_billet = $req->fetch()) { 
    $posts[] = $donnees_billet;
}
//----------------------------------------------------------------------//


//----------------------------------------------------------------------//
//              FERMETURE DE LA BASE
//----------------------------------------------------------------------//
$req->closeCursor();
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              PREPARATION DES DONNEES POUR LA VUE
//----------------------------------------------------------------------//
$DATA = array(
    "NB" => $nbr_billets['nb_billets'],
    "POSTS" => $posts,
);
//----------------------------------------------------------------------//


//----------------------------------------------------------------------//
//              RECUPERATION DU TEMPLATE (ou vue)
//----------------------------------------------------------------------//
$template = file_get_contents('View_Index.html');
//----------------------------------------------------------------------//



//----------------------------------------------------------------------//
//              AFFICHAGE
//----------------------------------------------------------------------//
$m = new Mustache_Engine();
echo $m->render($template, $DATA); 
//----------------------------------------------------------------------//

?>
